name: "Go Security"

# Reusable workflow for comprehensive Go security scanning
# Includes vulnerability detection, secret scanning, license checks, and SBOM generation
# Supports scheduled scans and manual triggering

on:
  workflow_call:
    inputs:
      runner_type:
        description: 'GitHub runner type to use'
        type: string
        default: 'ubuntu-latest'
      go_version:
        description: 'Go version to use for security scanning'
        type: string
        default: '1.23'
      enable_dependency_review:
        description: 'Enable GitHub dependency review (PR only)'
        type: boolean
        default: true
      enable_gosec:
        description: 'Enable Gosec security scanner'
        type: boolean
        default: true
      enable_govulncheck:
        description: 'Enable Go official vulnerability database check'
        type: boolean
        default: true
      enable_nancy:
        description: 'Enable Nancy dependency vulnerability scanner'
        type: boolean
        default: true
      enable_trivy:
        description: 'Enable Trivy filesystem security scanner'
        type: boolean
        default: true
      enable_secret_scan:
        description: 'Enable TruffleHog secret scanning'
        type: boolean
        default: true
      enable_license_check:
        description: 'Enable go-licenses compliance check'
        type: boolean
        default: true
      enable_sbom:
        description: 'Enable SBOM (Software Bill of Materials) generation'
        type: boolean
        default: true
      trivy_severity:
        description: 'Trivy severity levels to report (comma-separated: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN)'
        type: string
        default: 'CRITICAL,HIGH'
      license_disallowed_types:
        description: 'Disallowed license types for go-licenses (comma-separated)'
        type: string
        default: 'forbidden,restricted'
      upload_sarif:
        description: 'Upload SARIF results to GitHub Security tab'
        type: boolean
        default: true
      fail_on_security_issues:
        description: 'Fail the workflow if critical security issues are found'
        type: boolean
        default: true

permissions:
  contents: read
  security-events: write

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ${{ inputs.runner_type }}
    if: github.event_name == 'pull_request' && inputs.enable_dependency_review

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  gosec:
    name: Gosec Security Scan
    runs-on: ${{ inputs.runner_type }}
    if: inputs.enable_gosec

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          cache: true

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'

      - name: Upload Gosec SARIF
        if: always() && inputs.upload_sarif
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif
          category: gosec

  govulncheck:
    name: Go Vulnerability Check
    runs-on: ${{ inputs.runner_type }}
    if: inputs.enable_govulncheck

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

  nancy:
    name: Nancy Dependency Check
    runs-on: ${{ inputs.runner_type }}
    if: inputs.enable_nancy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          cache: true

      - name: Write go list to file
        run: go list -json -m all > go.list

      - name: Nancy vulnerability scan
        uses: sonatype-nexus-community/nancy-github-action@main
        with:
          nancyCommand: sleuth --loud
        continue-on-error: true

  trivy:
    name: Trivy Security Scan
    runs-on: ${{ inputs.runner_type }}
    if: inputs.enable_trivy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ inputs.trivy_severity }}

      - name: Upload Trivy SARIF
        if: always() && inputs.upload_sarif
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy

  secret-scan:
    name: Secret Scanning
    runs-on: ${{ inputs.runner_type }}
    if: inputs.enable_secret_scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  license-check:
    name: License Check
    runs-on: ${{ inputs.runner_type }}
    if: inputs.enable_license_check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          cache: true

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check licenses
        run: |
          go-licenses check ./... --disallowed_types=${{ inputs.license_disallowed_types }}

      - name: Generate license report
        run: |
          go-licenses report ./... > licenses.txt
          cat licenses.txt

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.txt
          retention-days: 30

  sbom:
    name: Generate SBOM
    runs-on: ${{ inputs.runner_type }}
    if: inputs.enable_sbom

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          cache: true

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

  security-summary:
    name: Security Summary
    runs-on: ${{ inputs.runner_type }}
    needs: [gosec, govulncheck, nancy, trivy, secret-scan, license-check, sbom]
    if: always()

    steps:
      - name: Check all security jobs
        run: |
          echo "Security Scan Results:"
          echo "  - Gosec: ${{ needs.gosec.result }}"
          echo "  - Govulncheck: ${{ needs.govulncheck.result }}"
          echo "  - Nancy: ${{ needs.nancy.result }}"
          echo "  - Trivy: ${{ needs.trivy.result }}"
          echo "  - Secret Scan: ${{ needs.secret-scan.result }}"
          echo "  - License Check: ${{ needs.license-check.result }}"
          echo "  - SBOM: ${{ needs.sbom.result }}"

          if [[ "${{ inputs.fail_on_security_issues }}" == "true" ]]; then
            if [[ "${{ needs.gosec.result }}" == "failure" ]] || \
               [[ "${{ needs.govulncheck.result }}" == "failure" ]] || \
               [[ "${{ needs.trivy.result }}" == "failure" ]] || \
               [[ "${{ needs.secret-scan.result }}" == "failure" ]] || \
               [[ "${{ needs.license-check.result }}" == "failure" ]]; then
              echo "⚠️ One or more critical security checks failed"
              exit 1
            fi
          fi

          echo "✅ Security scan completed"
