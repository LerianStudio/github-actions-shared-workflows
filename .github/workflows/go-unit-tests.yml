name: "Go Unit Tests"

# Reusable workflow for running Go unit tests
# Executes fast unit tests across multiple Go versions and platforms
# Supports parallel execution, race detection, and test result reporting

on:
  workflow_call:
    inputs:
      go_versions:
        description: 'JSON array of Go versions to test (e.g., ["1.21", "1.22", "1.23"])'
        type: string
        default: '["1.21", "1.22", "1.23"]'
      operating_systems:
        description: 'JSON array of operating systems (e.g., ["ubuntu-latest", "macos-latest", "windows-latest"])'
        type: string
        default: '["ubuntu-latest"]'
      runner_type:
        description: 'GitHub runner type for single-platform runs'
        type: string
        default: 'firmino-lxc-runners'
      test_cmd:
        description: 'Test command to execute'
        type: string
        default: 'go test -v -short ./...'
      enable_race_detector:
        description: 'Enable race detector (-race flag)'
        type: boolean
        default: true
      enable_coverage:
        description: 'Generate coverage reports'
        type: boolean
        default: false
      test_timeout:
        description: 'Test timeout (e.g., 10m, 1h)'
        type: string
        default: '10m'
      enable_matrix:
        description: 'Run tests across multiple Go versions and OS'
        type: boolean
        default: false
      enable_test_summary:
        description: 'Generate test summary report'
        type: boolean
        default: true
      fail_fast:
        description: 'Stop on first test failure in matrix'
        type: boolean
        default: false
      parallel_count:
        description: 'Number of parallel test executions (0 = default)'
        type: number
        default: 0
      test_flags:
        description: 'Additional flags for go test command'
        type: string
        default: ''
      include_integration_tests:
        description: 'Include integration tests (removes -short flag)'
        type: boolean
        default: false

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  unit-tests-single:
    name: Unit Tests
    runs-on: ${{ inputs.runner_type }}
    if: ${{ !inputs.enable_matrix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_versions != '' && fromJSON(inputs.go_versions)[0] || '1.23' }}
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Build test command
        id: test_cmd
        run: |
          CMD="${{ inputs.test_cmd }}"

          # Add race detector if enabled
          if [[ "${{ inputs.enable_race_detector }}" == "true" ]] && [[ ! "$CMD" =~ "-race" ]]; then
            CMD="$CMD -race"
          fi

          # Add coverage if enabled
          if [[ "${{ inputs.enable_coverage }}" == "true" ]] && [[ ! "$CMD" =~ "-coverprofile" ]]; then
            CMD="$CMD -coverprofile=coverage.txt -covermode=atomic"
          fi

          # Add timeout
          if [[ ! "$CMD" =~ "-timeout" ]]; then
            CMD="$CMD -timeout=${{ inputs.test_timeout }}"
          fi

          # Add parallel count if specified
          if [[ "${{ inputs.parallel_count }}" != "0" ]]; then
            CMD="$CMD -parallel=${{ inputs.parallel_count }}"
          fi

          # Remove -short if integration tests are included
          if [[ "${{ inputs.include_integration_tests }}" == "true" ]]; then
            CMD="${CMD//-short/}"
          fi

          # Add additional flags
          if [[ -n "${{ inputs.test_flags }}" ]]; then
            CMD="$CMD ${{ inputs.test_flags }}"
          fi

          echo "command=$CMD" >> $GITHUB_OUTPUT
          echo "Running: $CMD"

      - name: Run unit tests
        run: ${{ steps.test_cmd.outputs.command }}

      - name: Upload coverage
        if: inputs.enable_coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.txt
          retention-days: 7

      - name: Test summary
        if: inputs.enable_test_summary && always()
        run: |
          echo "## Unit Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Version**: $(go version)" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  unit-tests-matrix:
    name: Unit Tests (Go ${{ matrix.go-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: inputs.enable_matrix
    strategy:
      fail-fast: ${{ inputs.fail_fast }}
      matrix:
        go-version: ${{ fromJSON(inputs.go_versions) }}
        os: ${{ fromJSON(inputs.operating_systems) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Build test command
        id: test_cmd
        shell: bash
        run: |
          CMD="${{ inputs.test_cmd }}"

          # Add race detector if enabled
          if [[ "${{ inputs.enable_race_detector }}" == "true" ]] && [[ ! "$CMD" =~ "-race" ]]; then
            CMD="$CMD -race"
          fi

          # Add coverage if enabled
          if [[ "${{ inputs.enable_coverage }}" == "true" ]] && [[ ! "$CMD" =~ "-coverprofile" ]]; then
            CMD="$CMD -coverprofile=coverage.txt -covermode=atomic"
          fi

          # Add timeout
          if [[ ! "$CMD" =~ "-timeout" ]]; then
            CMD="$CMD -timeout=${{ inputs.test_timeout }}"
          fi

          # Add parallel count if specified
          if [[ "${{ inputs.parallel_count }}" != "0" ]]; then
            CMD="$CMD -parallel=${{ inputs.parallel_count }}"
          fi

          # Remove -short if integration tests are included
          if [[ "${{ inputs.include_integration_tests }}" == "true" ]]; then
            CMD="${CMD//-short/}"
          fi

          # Add additional flags
          if [[ -n "${{ inputs.test_flags }}" ]]; then
            CMD="$CMD ${{ inputs.test_flags }}"
          fi

          echo "command=$CMD" >> $GITHUB_OUTPUT
          echo "Running: $CMD"

      - name: Run unit tests
        run: ${{ steps.test_cmd.outputs.command }}

      - name: Upload coverage
        if: inputs.enable_coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.go-version }}-${{ matrix.os }}
          path: coverage.txt
          retention-days: 7

      - name: Test summary
        if: inputs.enable_test_summary && always()
        run: |
          echo "## Unit Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Version**: ${{ matrix.go-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  test-results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    if: inputs.enable_test_summary && always()
    needs: [unit-tests-single, unit-tests-matrix]

    steps:
      - name: Generate summary
        run: |
          echo "## All Tests Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All unit test jobs have completed." >> $GITHUB_STEP_SUMMARY
