name: "PR Security Scan"

# This reusable workflow handles security scanning for pull requests
# - If filter_paths is provided: treats as monorepo and scans changed components
# - If filter_paths is empty/not provided: treats as single app and scans entire repo
# - Supports two monorepo types:
#   * Type 1 (default): Components in separate folders with individual Dockerfiles
#   * Type 2: Backend in root with ./Dockerfile, frontend in folder with folder/Dockerfile

on:
  workflow_call:
    inputs:
      runner_type:
        description: 'GitHub runner type to use'
        type: string
        default: 'ubuntu-latest'
      filter_paths:
        description: 'Paths to monitor for changes (newline separated). If not provided, treats as single app repo'
        type: string
        required: false
      path_level:
        description: 'Directory depth level to extract app name (only used for monorepo)'
        type: string
        default: '2'
      monorepo_type:
        description: 'Type of monorepo: "type1" (components in folders) or "type2" (backend in root, frontend in folder)'
        type: string
        default: 'type1'
      frontend_folder:
        description: 'Name of the frontend folder for type2 monorepos'
        type: string
        default: 'frontend'
      dockerhub_org:
        description: 'DockerHub organization name'
        type: string
        default: 'lerianstudio'
      docker_registry:
        description: 'Docker registry URL'
        type: string
        default: 'docker.io'
      dockerfile_name:
        description: 'Name of the Dockerfile'
        type: string
        default: 'Dockerfile'

permissions:
  id-token: write       # Required for OIDC authentication
  contents: read        # Required to checkout the repository
  pull-requests: write  # Allows commenting on PRs
  security-events: write # Required for security scanning

jobs:
  prepare_matrix:
    runs-on: ${{ inputs.runner_type }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker_registry }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get changed paths (monorepo)
        if: inputs.filter_paths != ''
        id: changed-paths
        uses: LerianStudio/github-actions-changed-paths@main
        with:
          filter_paths: ${{ inputs.filter_paths }}
          get_app_name: true
          path_level: ${{ inputs.path_level }}

      - name: Set matrix
        id: set-matrix
        run: |
          if [ "${{ inputs.filter_paths }}" = "" ]; then
            # Single app mode
            echo 'matrix=[{"name": "${{ github.event.repository.name }}", "working_dir": "."}]' >> $GITHUB_OUTPUT
          elif [ "${{ inputs.monorepo_type }}" = "type2" ]; then
            # Type 2 monorepo: backend in root, frontend in folder
            CHANGED_MATRIX='${{ steps.changed-paths.outputs.matrix }}'

            # Process the matrix to handle Type 2 logic
            PROCESSED_MATRIX=$(echo "$CHANGED_MATRIX" | jq -c '
              map(
                if .working_dir == "${{ inputs.frontend_folder }}" then
                  # Frontend changes - keep as is
                  .
                elif (.working_dir == ".github" or .working_dir == ".githooks") then
                  # Ignore .github and .githooks folders
                  empty
                else
                  # Backend changes - consolidate to root
                  {"name": "${{ github.event.repository.name }}", "working_dir": "."}
                end
              ) | unique_by(.working_dir)
            ')

            echo "matrix=$PROCESSED_MATRIX" >> $GITHUB_OUTPUT
          else
            # Type 1 monorepo mode (default)
            echo 'matrix=${{ steps.changed-paths.outputs.matrix }}' >> $GITHUB_OUTPUT
          fi

  security_scan:
    needs: prepare_matrix
    if: needs.prepare_matrix.outputs.matrix != '[]'
    runs-on: ${{ inputs.runner_type }}
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare_matrix.outputs.matrix) }}
    env:
      DOCKERHUB_ORG: ${{ inputs.dockerhub_org }}
      APP_NAME: ${{ matrix.name }}
      DOCKERFILE_PATH: ${{ matrix.working_dir == '.' && format('./{0}', inputs.dockerfile_name) || format('{0}/{1}', matrix.working_dir, inputs.dockerfile_name) }}

    steps:
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker_registry }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------- Security Scans -----------------
      - name: Trivy Secret Scan - Component (Table Output)
        uses: aquasecurity/trivy-action@0.33.1
        if: always()
        with:
          scan-type: fs
          scan-ref: ${{ matrix.working_dir }}
          format: table
          exit-code: '1'
          hide-progress: true
          skip-dirs: '.git,node_modules,dist,build,.next,coverage,vendor'

      - name: Trivy Secret Scan - Component (SARIF Output)
        uses: aquasecurity/trivy-action@0.33.1
        if: always()
        with:
          scan-type: fs
          scan-ref: ${{ matrix.working_dir }}
          format: sarif
          output: 'trivy-secret-scan-${{ env.APP_NAME }}.sarif'
          exit-code: '0'
          hide-progress: true
          skip-dirs: '.git,node_modules,dist,build,.next,coverage,vendor'

      - name: Build Docker Image for Scanning
        if: always()
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.monorepo_type == 'type2' && matrix.working_dir == inputs.frontend_folder && inputs.frontend_folder || '.' }}
          file: ${{ env.DOCKERFILE_PATH }}
          platforms: linux/amd64
          load: true
          push: false
          tags: ${{ env.DOCKERHUB_ORG }}/${{ env.APP_NAME }}:pr-scan-${{ github.sha }}
          secrets: |
            ${{ secrets.MANAGE_TOKEN && format('github_token={0}', secrets.MANAGE_TOKEN) || '' }}
            ${{ secrets.NPMRC_TOKEN && format('npmrc=//npm.pkg.github.com/:_authToken={0}', secrets.NPMRC_TOKEN) || '' }}

      - name: Trivy Vulnerability Scan - Docker Image (Table Output)
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKERHUB_ORG }}/${{ env.APP_NAME }}:pr-scan-${{ github.sha }}'
          format: 'table'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Trivy Vulnerability Scan - Docker Image (SARIF Output)
        if: always()
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ env.DOCKERHUB_ORG }}/${{ env.APP_NAME }}:pr-scan-${{ github.sha }}'
          format: sarif
          output: 'trivy-vulnerability-scan-docker-${{ env.APP_NAME }}.sarif'
          ignore-unfixed: true
          vuln-type: os,library
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
          exit-code: '0'  # Do not fail; gate failures in the table step

      ## To be fixed
      # - name: Upload Secret Scan Results - Repository (SARIF) to GitHub Security Tab
      #   uses: github/codeql-action/upload-sarif@v3
      #   if: always()
      #   continue-on-error: true
      #   with:
      #     sarif_file: 'trivy-secret-scan-repo-${{ env.APP_NAME }}.sarif'

      # - name: Upload Vulnerability Scan Results - Docker Image (SARIF) to GitHub Security Tab
      #   uses: github/codeql-action/upload-sarif@v3
      #   if: always()
      #   continue-on-error: true
      #   with:
      #     sarif_file: 'trivy-vulnerability-scan-docker-${{ env.APP_NAME }}.sarif'

  # Slack notification
  notify:
    name: Notify
    needs: [prepare_matrix, security_scan]
    if: always() && needs.prepare_matrix.outputs.matrix != '[]'
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: ${{ needs.security_scan.result }}
      workflow_name: "PR Security Scan"
      failed_jobs: ${{ needs.security_scan.result == 'failure' && 'Security Scan' || '' }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
