name: "Go Coverage Check"

# Reusable workflow for checking Go code coverage thresholds
# Validates that code coverage meets minimum requirements
# Posts coverage reports as PR comments and enforces coverage gates

on:
  workflow_call:
    inputs:
      runner_type:
        description: 'GitHub runner type'
        type: string
        default: 'ubuntu-latest'
      go_version:
        description: 'Go version to use for coverage check'
        type: string
        default: '1.23'
      coverage_threshold:
        description: 'Minimum coverage percentage required (0-100)'
        type: number
        default: 80
      coverage_file:
        description: 'Coverage file path'
        type: string
        default: 'coverage.txt'
      test_cmd:
        description: 'Test command to generate coverage'
        type: string
        default: 'go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...'
      enable_pr_comment:
        description: 'Post coverage report as PR comment'
        type: boolean
        default: true
      fail_on_threshold:
        description: 'Fail the workflow if coverage is below threshold'
        type: boolean
        default: true
      exclude_packages:
        description: 'Comma-separated list of packages to exclude from coverage (e.g., "cmd/main,internal/mocks")'
        type: string
        default: ''
      report_format:
        description: 'Coverage report format (text, html, or both)'
        type: string
        default: 'both'
    secrets:
      manage_token:
        description: 'GitHub token for posting PR comments (defaults to GITHUB_TOKEN if not provided)'
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage-check:
    name: Coverage Check
    runs-on: ${{ inputs.runner_type }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Run tests with coverage
        run: ${{ inputs.test_cmd }}

      - name: Calculate coverage percentage
        id: coverage
        run: |
          # Calculate total coverage
          COVERAGE=$(go tool cover -func=${{ inputs.coverage_file }} | grep total | awk '{print $3}' | sed 's/%//')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Total coverage: $COVERAGE%"

          # Generate coverage by package table
          echo "## Coverage by Package" > coverage-report.md
          echo "" >> coverage-report.md
          echo "| Package | Coverage |" >> coverage-report.md
          echo "|---------|----------|" >> coverage-report.md

          # Aggregate coverage by package
          go tool cover -func=${{ inputs.coverage_file }} | grep -v "total:" | awk '
          {
            if (NF >= 3) {
              # Extract package path from "file:line: function coverage"
              split($1, parts, ":");
              filepath = parts[1];

              # Remove filename to get package path
              split(filepath, pathparts, "/");
              n = length(pathparts);
              pkg = "";
              for (i = 1; i < n; i++) {
                if (i > 1) pkg = pkg "/";
                pkg = pkg pathparts[i];
              }

              # Extract coverage percentage
              cov_str = $NF;
              gsub(/%/, "", cov_str);
              cov = cov_str + 0;

              # Accumulate coverage data per package
              pkg_lines[pkg] += 1;
              pkg_coverage[pkg] += cov;
            }
          }
          END {
            # Calculate average coverage per package
            for (p in pkg_coverage) {
              if (pkg_lines[p] > 0) {
                avg = pkg_coverage[p] / pkg_lines[p];
                printf "| `%s` | %.1f%% |\n", p, avg;
              }
            }
          }' | sort >> coverage-report.md

          echo ""
          echo "Coverage report generated:"
          cat coverage-report.md

      - name: Check coverage threshold
        if: inputs.fail_on_threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=${{ inputs.coverage_threshold }}

          echo "Coverage: $COVERAGE%"
          echo "Threshold: $THRESHOLD%"

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          else
            echo "::notice::Coverage $COVERAGE% meets threshold $THRESHOLD%"
          fi

      - name: Generate HTML coverage report
        if: inputs.report_format == 'html' || inputs.report_format == 'both'
        run: |
          go tool cover -html=${{ inputs.coverage_file }} -o coverage.html

      - name: Upload coverage report
        if: inputs.report_format == 'html' || inputs.report_format == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            ${{ inputs.coverage_file }}
            coverage.html
          retention-days: 30

      - name: Post coverage comment
        if: inputs.enable_pr_comment && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.manage_token || secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const threshold = '${{ inputs.coverage_threshold }}';
            const passFail = parseFloat(coverage) >= parseFloat(threshold) ? 'âœ… PASS' : 'âŒ FAIL';

            let coverageReport = '';
            try {
              coverageReport = fs.readFileSync('coverage-report.md', 'utf8');
            } catch (err) {
              coverageReport = 'Coverage report not available';
            }

            const body = `## ðŸ“Š Code Coverage Report

            **Overall Coverage**: \`${coverage}%\` ${passFail}
            **Threshold**: \`${threshold}%\`

            ${coverageReport}

            ---
            *Coverage threshold: ${threshold}% | Current: ${coverage}%*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Coverage summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Coverage**: ${{ steps.coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Threshold**: ${{ inputs.coverage_threshold }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.coverage.outputs.coverage >= inputs.coverage_threshold && 'âœ… PASS' || 'âŒ FAIL' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage by Function" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=${{ inputs.coverage_file }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
