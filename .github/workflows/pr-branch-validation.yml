name: "PR Branch Validation"

# Reusable workflow to validate PR source branches
# Ensures PRs to protected branches (like main) come only from allowed source branches

on:
  workflow_call:
    inputs:
      runner_type:
        description: 'GitHub runner type'
        type: string
        default: 'ubuntu-24.04'
      allowed_branches:
        description: 'Comma-separated list of allowed source branches (e.g., "develop,release-candidate")'
        type: string
        default: 'develop,release-candidate'
      allowed_prefixes:
        description: 'Comma-separated list of allowed branch prefixes (e.g., "hotfix/,bugfix/")'
        type: string
        default: 'hotfix/'
      rejection_message:
        description: 'Message to post when PR is rejected'
        type: string
        default: 'Pull requests to **main** can only come from **develop**, **release-candidate**, or **hotfix/** branches. Please **change base**!!!'
    secrets:
      lerian_studio_push_bot_app_id:
        description: 'GitHub App ID for authentication'
        required: true
      lerian_studio_push_bot_private_key:
        description: 'GitHub App private key'
        required: true
      lerian_ci_cd_user_gpg_key:
        description: 'GPG key for signing'
        required: false
      lerian_ci_cd_user_gpg_key_password:
        description: 'GPG key password'
        required: false
      lerian_ci_cd_user_name:
        description: 'CI/CD user name'
        required: false
      lerian_ci_cd_user_email:
        description: 'CI/CD user email'
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  check-branch:
    runs-on: ${{ inputs.runner_type }}
    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.lerian_studio_push_bot_app_id }}
          private-key: ${{ secrets.lerian_studio_push_bot_private_key }}

      - name: Import GPG key
        if: ${{ secrets.lerian_ci_cd_user_gpg_key != '' }}
        uses: crazy-max/ghaction-import-gpg@v6
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.lerian_ci_cd_user_gpg_key }}
          passphrase: ${{ secrets.lerian_ci_cd_user_gpg_key_password }}
          git_committer_name: ${{ secrets.lerian_ci_cd_user_name }}
          git_committer_email: ${{ secrets.lerian_ci_cd_user_email }}
          git_config_global: true
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Validate source branch
        id: validate
        shell: bash
        env:
          SOURCE_BRANCH: ${{ github.event.pull_request.head.ref }}
          ALLOWED_BRANCHES: ${{ inputs.allowed_branches }}
          ALLOWED_PREFIXES: ${{ inputs.allowed_prefixes }}
        run: |
          echo "Checking source branch: $SOURCE_BRANCH"

          # Check exact branch matches
          IFS=',' read -ra BRANCHES <<< "$ALLOWED_BRANCHES"
          for branch in "${BRANCHES[@]}"; do
            branch=$(echo "$branch" | xargs)  # trim whitespace
            if [[ "$SOURCE_BRANCH" == "$branch" ]]; then
              echo "✅ Branch '$SOURCE_BRANCH' is allowed (exact match)"
              echo "allowed=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          # Check prefix matches
          IFS=',' read -ra PREFIXES <<< "$ALLOWED_PREFIXES"
          for prefix in "${PREFIXES[@]}"; do
            prefix=$(echo "$prefix" | xargs)  # trim whitespace
            if [[ "$SOURCE_BRANCH" == "$prefix"* ]]; then
              echo "✅ Branch '$SOURCE_BRANCH' is allowed (prefix match: $prefix)"
              echo "allowed=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          echo "❌ Branch '$SOURCE_BRANCH' is NOT allowed"
          echo "allowed=false" >> "$GITHUB_OUTPUT"

      - name: Post rejection comment
        if: steps.validate.outputs.allowed == 'false'
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          GIT_AUTHOR_NAME: ${{ secrets.lerian_ci_cd_user_name }}
          GIT_AUTHOR_EMAIL: ${{ secrets.lerian_ci_cd_user_email }}
          GIT_COMMITTER_NAME: ${{ secrets.lerian_ci_cd_user_name }}
          GIT_COMMITTER_EMAIL: ${{ secrets.lerian_ci_cd_user_email }}
        run: |
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"body": "${{ inputs.rejection_message }}", "event": "REQUEST_CHANGES"}' \
            "${{ github.event.pull_request.url }}/reviews"

      - name: Fail if not allowed
        if: steps.validate.outputs.allowed == 'false'
        run: |
          echo "::error::PR source branch is not allowed"
          exit 1
