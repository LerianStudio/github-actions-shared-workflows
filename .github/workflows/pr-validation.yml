name: "PR Validation"

# Reusable workflow for comprehensive pull request validation
# Checks PR title, size, description, labels, and best practices

on:
  workflow_call:
    inputs:
      runner_type:
        description: 'GitHub runner type to use'
        type: string
        default: 'ubuntu-latest'
      pr_title_types:
        description: 'Allowed commit types (pipe-separated)'
        type: string
        default: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          chore
          ci
          build
          revert
      pr_title_scopes:
        description: 'Allowed scopes (pipe-separated, empty = any scope allowed)'
        type: string
        default: ''
      require_scope:
        description: 'Require scope in PR title'
        type: boolean
        default: false
      min_description_length:
        description: 'Minimum PR description length'
        type: number
        default: 50
      check_changelog:
        description: 'Check if CHANGELOG.md is updated'
        type: boolean
        default: true
      enable_auto_labeler:
        description: 'Enable automatic labeling based on changed files'
        type: boolean
        default: true
      labeler_config_path:
        description: 'Path to labeler configuration file'
        type: string
        default: '.github/labeler.yml'
    secrets:
      github_token:
        description: 'GitHub token for API operations (defaults to GITHUB_TOKEN if not provided)'
        required: false

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  skip-if-draft:
    name: Skip if Draft
    runs-on: ${{ inputs.runner_type }}
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: Check if draft
        id: check
        run: |
          if [ "${{ github.event.pull_request.draft }}" = "true" ]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

  pr-title:
    name: Validate PR Title
    runs-on: ${{ inputs.runner_type }}
    needs: skip-if-draft
    if: needs.skip-if-draft.outputs.should_skip != 'true'

    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: ${{ inputs.pr_title_types }}
          scopes: ${{ inputs.pr_title_scopes }}
          requireScope: ${{ inputs.require_scope }}
          subjectPattern: ^[a-z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with a lowercase character.

  pr-size:
    name: Check PR Size
    runs-on: ${{ inputs.runner_type }}
    needs: skip-if-draft
    if: needs.skip-if-draft.outputs.should_skip != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        id: size
        run: |
          # Get changed lines
          CHANGED_LINES=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | \
            awk '{print $4+$6}')
          echo "changed_lines=$CHANGED_LINES" >> $GITHUB_OUTPUT

          # Set size label
          if [ "$CHANGED_LINES" -lt 50 ]; then
            SIZE="XS"
          elif [ "$CHANGED_LINES" -lt 200 ]; then
            SIZE="S"
          elif [ "$CHANGED_LINES" -lt 500 ]; then
            SIZE="M"
          elif [ "$CHANGED_LINES" -lt 1000 ]; then
            SIZE="L"
          else
            SIZE="XL"
          fi
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Add size label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
          script: |
            const size = '${{ steps.size.outputs.size }}';
            const labels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];

            // Remove existing size labels
            for (const label of labels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              } catch (error) {
                // Label doesn't exist, ignore
              }
            }

            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [`size/${size}`]
            });

      - name: Comment on large PR
        if: steps.size.outputs.size == 'XL'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `This PR is very large (${context.payload.pull_request.changed_files} files, ${{ steps.size.outputs.changed_lines }} lines changed). Consider breaking it into smaller PRs for easier review.`
            });

  pr-description:
    name: Check PR Description
    runs-on: ${{ inputs.runner_type }}
    needs: skip-if-draft
    if: needs.skip-if-draft.outputs.should_skip != 'true'

    steps:
      - name: Check description length
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.pull_request.body || '';
            const minLength = ${{ inputs.min_description_length }};

            if (body.length < minLength) {
              core.setFailed(`PR description is too short (${body.length} chars). Please provide a detailed description (minimum ${minLength} chars).`);
            }

      - name: Check for required sections
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.pull_request.body || '';
            const requiredSections = ['Description', 'Type of Change'];
            const missingSections = [];

            for (const section of requiredSections) {
              if (!body.includes(section)) {
                missingSections.push(section);
              }
            }

            if (missingSections.length > 0) {
              core.warning(`PR description is missing recommended sections: ${missingSections.join(', ')}`);
            }

  pr-labels:
    name: Auto-label PR
    runs-on: ${{ inputs.runner_type }}
    needs: skip-if-draft
    if: needs.skip-if-draft.outputs.should_skip != 'true' && inputs.enable_auto_labeler

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto-label based on files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: ${{ inputs.labeler_config_path }}
          sync-labels: true

  pr-assignee:
    name: Check Assignee
    runs-on: ${{ inputs.runner_type }}
    needs: skip-if-draft
    if: needs.skip-if-draft.outputs.should_skip != 'true'

    steps:
      - name: Check for assignee
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (pr.assignees.length === 0) {
              core.warning('This PR has no assignees. Consider assigning someone to review.');
            }

  pr-linked-issues:
    name: Check Linked Issues
    runs-on: ${{ inputs.runner_type }}
    needs: skip-if-draft
    if: needs.skip-if-draft.outputs.should_skip != 'true'

    steps:
      - name: Check for linked issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
          script: |
            const body = context.payload.pull_request.body || '';
            const issueKeywords = ['closes', 'fixes', 'resolves', 'relates to'];

            let hasLinkedIssue = false;
            for (const keyword of issueKeywords) {
              if (body.toLowerCase().includes(keyword)) {
                hasLinkedIssue = true;
                break;
              }
            }

            if (!hasLinkedIssue) {
              core.warning('This PR does not appear to be linked to any issues. Consider linking related issues using keywords like "Closes #123" or "Fixes #456".');
            }

  pr-changelog:
    name: Check Changelog Update
    runs-on: ${{ inputs.runner_type }}
    needs: skip-if-draft
    if: needs.skip-if-draft.outputs.should_skip != 'true' && inputs.check_changelog

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if CHANGELOG updated
        id: changelog
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment if CHANGELOG not updated
        if: steps.changelog.outputs.updated == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);

            // Skip for certain labels
            if (labels.includes('skip-changelog') || labels.includes('dependencies')) {
              return;
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'Consider updating CHANGELOG.md to document this change. If this change doesn\'t need a changelog entry, add the `skip-changelog` label.'
            });

  pr-checks-summary:
    name: PR Checks Summary
    runs-on: ${{ inputs.runner_type }}
    needs: [pr-title, pr-size, pr-description, pr-labels, pr-assignee, pr-linked-issues, pr-changelog]
    if: always()

    steps:
      - name: Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || secrets.GITHUB_TOKEN }}
          script: |
            const checks = {
              'PR Title': '${{ needs.pr-title.result }}',
              'PR Size': '${{ needs.pr-size.result }}',
              'PR Description': '${{ needs.pr-description.result }}',
              'Auto-label': '${{ needs.pr-labels.result }}',
              'Assignee Check': '${{ needs.pr-assignee.result }}',
              'Linked Issues': '${{ needs.pr-linked-issues.result }}',
              'Changelog': '${{ needs.pr-changelog.result }}'
            };

            let summary = '## PR Checks Summary\n\n';
            for (const [check, result] of Object.entries(checks)) {
              const icon = result === 'success' ? '✅' : result === 'failure' ? '❌' : '⚠️';
              summary += `${icon} ${check}: ${result}\n`;
            }

            core.summary.addRaw(summary);
            await core.summary.write();
