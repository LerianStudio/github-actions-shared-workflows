name: "Frontend PR Analysis"

# Reusable workflow for Frontend/Node.js PR analysis in monorepos
# Handles change detection, linting, type checking, security, tests, and coverage
# All logic is centralized here for easy maintenance
#
# Features:
# - Change detection for monorepo and single-app repositories
# - ESLint for code quality
# - TypeScript type checking
# - npm audit for security vulnerabilities
# - Jest/Vitest unit tests with coverage
# - Coverage threshold with PR comments
# - Build verification
# - Slack notifications on failure
# - Support for npm, yarn, and pnpm package managers

on:
  workflow_call:
    inputs:
      runner_type:
        description: 'GitHub runner type'
        type: string
        default: 'blacksmith-4vcpu-ubuntu-2404'
      filter_paths:
        description: 'JSON array of paths to monitor for changes (e.g., ["apps/web", "apps/console"]). If empty, treats repo as single-app and runs against root directory.'
        type: string
        required: false
        default: ''
      path_level:
        description: 'Directory depth level to extract app name'
        type: number
        default: 2
      app_name_prefix:
        description: 'Prefix for app names in matrix output'
        type: string
        default: ''
      node_version:
        description: 'Node.js version to use'
        type: string
        default: '22'
      package_manager:
        description: 'Package manager to use (npm, yarn, pnpm)'
        type: string
        default: 'npm'
      eslint_args:
        description: 'Additional arguments for ESLint'
        type: string
        default: ''
      audit_level:
        description: 'npm audit severity level (low, moderate, high, critical)'
        type: string
        default: 'high'
      coverage_threshold:
        description: 'Minimum coverage percentage required (0-100)'
        type: number
        default: 80
      fail_on_coverage_threshold:
        description: 'Fail the workflow if coverage is below threshold'
        type: boolean
        default: false
      enable_lint:
        description: 'Enable ESLint'
        type: boolean
        default: true
      enable_typecheck:
        description: 'Enable TypeScript type checking'
        type: boolean
        default: true
      enable_security:
        description: 'Enable security scanning (npm audit)'
        type: boolean
        default: true
      enable_tests:
        description: 'Enable unit tests'
        type: boolean
        default: true
      enable_coverage:
        description: 'Enable coverage check with PR comment'
        type: boolean
        default: true
      enable_build:
        description: 'Enable build verification'
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # ============================================
  # CHANGE DETECTION
  # ============================================
  detect-changes:
    name: Detect Changes
    runs-on: ${{ inputs.runner_type }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            git fetch origin $BASE_SHA --depth=1 2>/dev/null || true
            FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA 2>/dev/null || git diff --name-only origin/${{ github.base_ref }}...HEAD)
          elif [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]] || [[ -z "${{ github.event.before }}" ]]; then
            PREV_COMMIT=$(git rev-parse HEAD^)
            if [[ $? -eq 0 ]]; then
              FILES=$(git diff --name-only $PREV_COMMIT HEAD)
            else
              FILES=$(git ls-tree -r --name-only HEAD)
            fi
          else
            FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          printf "files<<EOF\n%s\nEOF\n" "$FILES" >> "$GITHUB_OUTPUT"

      - name: Build matrix from changed paths
        id: set-matrix
        shell: bash
        run: |
          FILES="${{ steps.changed.outputs.files }}"
          FILTER_PATHS='${{ inputs.filter_paths }}'
          PATH_LEVEL="${{ inputs.path_level }}"
          APP_NAME_PREFIX="${{ inputs.app_name_prefix }}"

          if [[ -z "$FILES" ]]; then
            echo "No files changed."
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Single-app mode: if filter_paths is empty, run against root directory
          if [[ -z "$FILTER_PATHS" ]] || [[ "$FILTER_PATHS" == "[]" ]] || [[ "$FILTER_PATHS" == "" ]]; then
            echo "Single-app mode: no filter_paths specified, running against root directory"
            if [[ -n "$APP_NAME_PREFIX" ]]; then
              APP_NAME="$APP_NAME_PREFIX"
            else
              APP_NAME="app"
            fi
            MATRIX="[{\"name\":\"$APP_NAME\",\"working_dir\":\".\"}]"
            echo "Single app matrix: $MATRIX"
            echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Monorepo mode: filter and build matrix from changed paths
          echo "Monorepo mode: filtering by paths $FILTER_PATHS"

          DIRS=$(echo "$FILES" | xargs -n1 dirname)

          if [[ -n "$PATH_LEVEL" ]] && [[ "$PATH_LEVEL" -gt 0 ]]; then
            DIRS=$(echo "$DIRS" | cut -d'/' -f-"$PATH_LEVEL")
          fi

          FILTER_LIST=$(echo "$FILTER_PATHS" | jq -r '.[]' 2>/dev/null || echo "")
          if [[ -n "$FILTER_LIST" ]]; then
            FILTERED=""
            while read -r DIR; do
              while read -r FILTER; do
                if [[ "$DIR" == "$FILTER"* ]]; then
                  FILTERED+="$DIR"$'\n'
                  break
                fi
              done <<< "$FILTER_LIST"
            done <<< "$DIRS"
            DIRS="$FILTERED"
          fi

          DIRS=$(echo "$DIRS" | grep -v '^$' | sort -u || true)

          if [[ -z "$DIRS" ]]; then
            echo "No matching directories found."
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MATRIX="["
          FIRST=true
          while read -r DIR; do
            if [[ -n "$APP_NAME_PREFIX" ]]; then
              APP_NAME="${APP_NAME_PREFIX}-$(echo "$DIR" | rev | cut -d'/' -f1 | rev)"
            else
              APP_NAME="$(echo "$DIR" | rev | cut -d'/' -f1 | rev)"
            fi
            ENTRY="{\"name\":\"$APP_NAME\",\"working_dir\":\"$DIR\"}"
            if $FIRST; then
              MATRIX+="$ENTRY"
              FIRST=false
            else
              MATRIX+=",$ENTRY"
            fi
          done <<< "$DIRS"
          MATRIX+="]"

          echo "Changed apps matrix: $MATRIX"
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

  # ============================================
  # ESLINT
  # ============================================
  lint:
    name: Lint (${{ matrix.app.name }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && inputs.enable_lint
    runs-on: ${{ inputs.runner_type }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager }}
          cache-dependency-path: ${{ matrix.app.working_dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn install --frozen-lockfile ;;
            pnpm) pnpm install --frozen-lockfile ;;
            *) npm ci ;;
          esac

      - name: Run ESLint
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn eslint . ${{ inputs.eslint_args }} ;;
            pnpm) pnpm eslint . ${{ inputs.eslint_args }} ;;
            *) npx eslint . ${{ inputs.eslint_args }} ;;
          esac

  # ============================================
  # TYPESCRIPT TYPE CHECK
  # ============================================
  typecheck:
    name: Type Check (${{ matrix.app.name }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && inputs.enable_typecheck
    runs-on: ${{ inputs.runner_type }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager }}
          cache-dependency-path: ${{ matrix.app.working_dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn install --frozen-lockfile ;;
            pnpm) pnpm install --frozen-lockfile ;;
            *) npm ci ;;
          esac

      - name: Run TypeScript compiler
        working-directory: ${{ matrix.app.working_dir }}
        run: npx tsc --noEmit

  # ============================================
  # SECURITY SCANNING
  # ============================================
  security:
    name: Security (${{ matrix.app.name }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && inputs.enable_security
    runs-on: ${{ inputs.runner_type }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager }}
          cache-dependency-path: ${{ matrix.app.working_dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn install --frozen-lockfile ;;
            pnpm) pnpm install --frozen-lockfile ;;
            *) npm ci ;;
          esac

      - name: Run npm audit
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn audit --level ${{ inputs.audit_level }} || true ;;
            pnpm) pnpm audit --audit-level ${{ inputs.audit_level }} || true ;;
            *) npm audit --omit=dev --audit-level ${{ inputs.audit_level }} ;;
          esac

  # ============================================
  # UNIT TESTS
  # ============================================
  tests:
    name: Tests (${{ matrix.app.name }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && inputs.enable_tests
    runs-on: ${{ inputs.runner_type }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager }}
          cache-dependency-path: ${{ matrix.app.working_dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn install --frozen-lockfile ;;
            pnpm) pnpm install --frozen-lockfile ;;
            *) npm ci ;;
          esac

      - name: Run tests with coverage
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn test --coverage --coverageReporters=text --coverageReporters=json-summary --coverageReporters=lcov ;;
            pnpm) pnpm test --coverage --coverageReporters=text --coverageReporters=json-summary --coverageReporters=lcov ;;
            *) npm test -- --coverage --coverageReporters=text --coverageReporters=json-summary --coverageReporters=lcov ;;
          esac

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: coverage-${{ matrix.app.name }}
          path: |
            ${{ matrix.app.working_dir }}/coverage/
          retention-days: 7

  # ============================================
  # COVERAGE CHECK
  # ============================================
  coverage:
    name: Coverage (${{ matrix.app.name }})
    needs: [detect-changes, tests]
    if: needs.detect-changes.outputs.has_changes == 'true' && inputs.enable_coverage
    runs-on: ${{ inputs.runner_type }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download coverage artifact
        uses: actions/download-artifact@v7
        with:
          name: coverage-${{ matrix.app.name }}
          path: ${{ matrix.app.working_dir }}/coverage

      - name: Parse coverage
        id: coverage
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          if [[ -f coverage/coverage-summary.json ]]; then
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
            
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
            echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "Total line coverage: $COVERAGE%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "statements=0" >> $GITHUB_OUTPUT
            echo "branches=0" >> $GITHUB_OUTPUT
            echo "functions=0" >> $GITHUB_OUTPUT
            echo "No coverage file found"
          fi

      - name: Post coverage comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.MANAGE_TOKEN || github.token }}
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const statements = '${{ steps.coverage.outputs.statements }}';
            const branches = '${{ steps.coverage.outputs.branches }}';
            const functions = '${{ steps.coverage.outputs.functions }}';
            const threshold = '${{ inputs.coverage_threshold }}';
            const appName = '${{ matrix.app.name }}';
            const passFail = parseFloat(coverage) >= parseFloat(threshold) ? 'âœ… PASS' : 'âš ï¸ BELOW THRESHOLD';

            const body = `## ðŸ“Š Unit Test Coverage Report: \`${appName}\`

            | Metric | Value | Status |
            |--------|-------|--------|
            | **Lines** | \`${coverage}%\` | ${passFail} |
            | **Statements** | \`${statements}%\` | |
            | **Branches** | \`${branches}%\` | |
            | **Functions** | \`${functions}%\` | |
            | **Threshold** | \`${threshold}%\` | |

            ---
            *Generated by Frontend PR Analysis workflow*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.body.includes(`Unit Test Coverage Report: \`${appName}\``)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check coverage threshold
        if: inputs.fail_on_coverage_threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=${{ inputs.coverage_threshold }}
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          fi

      - name: Coverage summary
        run: |
          echo "## Coverage Summary: ${{ matrix.app.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines | ${{ steps.coverage.outputs.coverage }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Statements | ${{ steps.coverage.outputs.statements }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | ${{ steps.coverage.outputs.branches }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${{ steps.coverage.outputs.functions }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold | ${{ inputs.coverage_threshold }}% |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # BUILD VERIFICATION
  # ============================================
  build:
    name: Build (${{ matrix.app.name }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && inputs.enable_build
    runs-on: ${{ inputs.runner_type }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager }}
          cache-dependency-path: ${{ matrix.app.working_dir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn install --frozen-lockfile ;;
            pnpm) pnpm install --frozen-lockfile ;;
            *) npm ci ;;
          esac

      - name: Build
        working-directory: ${{ matrix.app.working_dir }}
        run: |
          case "${{ inputs.package_manager }}" in
            yarn) yarn build ;;
            pnpm) pnpm build ;;
            *) npm run build ;;
          esac

  # ============================================
  # NO CHANGES DETECTED
  # ============================================
  no-changes:
    name: No Frontend Changes
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes != 'true'
    runs-on: ${{ inputs.runner_type }}
    steps:
      - name: Skip
        run: |
          echo "No frontend code changes detected in monitored paths."
          echo "Skipping frontend analysis workflows."

  # ============================================
  # SLACK NOTIFICATION
  # ============================================
  notify:
    name: Notify
    needs: [detect-changes, lint, typecheck, security, tests, build]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    uses: ./.github/workflows/slack-notify.yml
    with:
      status: ${{ (needs.lint.result == 'failure' || needs.typecheck.result == 'failure' || needs.security.result == 'failure' || needs.tests.result == 'failure' || needs.build.result == 'failure') && 'failure' || 'success' }}
      workflow_name: "Frontend PR Analysis"
      failed_jobs: ${{ needs.lint.result == 'failure' && 'Lint, ' || '' }}${{ needs.typecheck.result == 'failure' && 'TypeCheck, ' || '' }}${{ needs.security.result == 'failure' && 'Security, ' || '' }}${{ needs.tests.result == 'failure' && 'Tests, ' || '' }}${{ needs.build.result == 'failure' && 'Build' || '' }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
